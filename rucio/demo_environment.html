

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Setting up a Rucio development environment &mdash; Rucio 1.2 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Rucio administration CLI: Examples" href="cli_admin_examples.html" />
    <link rel="prev" title="Policy packages" href="policy_packages.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> Rucio
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="concepts.html">Concepts and terminology</a></li>
<li class="toctree-l1"><a class="reference internal" href="replica_workflow.html">Typical replica workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="releasepolicy.html">Release policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="releasenotes.html">Release notes</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributor Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="developing.html">Setting up a Rucio development environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="rest.html">RESTful APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">The Client API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="database.html">Database operations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installing_clients.html">Installing Rucio Clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli_examples.html">Rucio CLI: Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="man/rucio.html">Rucio CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="man/rucio-admin.html">Rucio Administrative CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="rse_expressions.html">RSE Expressions</a></li>
<li class="toctree-l1"><a class="reference internal" href="clients.html">Rucio Clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="clients.html#errors-and-exceptions">Errors and Exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced_usage.html">Advanced Usage</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installing_server.html">Installing Rucio server</a></li>
<li class="toctree-l1"><a class="reference internal" href="installing_daemons.html">Installing Rucio daemons</a></li>
<li class="toctree-l1"><a class="reference internal" href="man/daemons.html">Daemons CLIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="monitoring.html">Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="policy_packages.html">Policy packages</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Setting up a Rucio development environment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="#preparing-the-environment">Preparing the environment</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#using-the-standard-environment">Using the standard environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-environment-including-storage">Using the environment including storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-environment-including-monitoring">Using the environment including monitoring</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#development">Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="#development-tricks">Development tricks</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#server-changes">Server changes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#database-access">Database access</a></li>
<li class="toctree-l3"><a class="reference internal" href="#docker-is-eating-my-disk-space">Docker is eating my disk space</a></li>
<li class="toctree-l3"><a class="reference internal" href="#where-do-i-find-the-dockerfile">Where do I find the Dockerfile</a></li>
<li class="toctree-l3"><a class="reference internal" href="#i-need-a-docker-based-on-another-branch-not-rucio-master">I need a Docker based on another branch (not rucio/master)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#start-the-daemons">Start the daemons</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cli_examples.html">Rucio CLI: Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli_admin_examples.html">Rucio administration CLI: Examples</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="authors.html">Individual contributors to the source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html#organisations-employing-contributors">Organisations employing contributors</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Rucio</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Setting up a Rucio development environment</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/demo_environment.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="setting-up-a-rucio-development-environment">
<h1>Setting up a Rucio development environment<a class="headerlink" href="#setting-up-a-rucio-development-environment" title="Permalink to this headline">¶</a></h1>
<div class="section" id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h2>
<p>We provide a containerised version of the Rucio development environment for a quick start. Our containers are ready-made for Docker, which means you need to have a working Docker installation. To install Docker for your platform, please refer to the <a class="reference external" href="https://docs.docker.com/install/">Docker installation guide</a>, for example, for CentOS <a class="reference external" href="https://docs.docker.com/install/linux/docker-ce/centos/">follow these instructions for the Docker Community Edition</a>. Please make sure that you install this recent Docker version especially if you are on CentOS, i.e. its default version is ancient and does not support some features we rely on.</p>
<p>Start the Docker daemon with <cite>sudo systemctl start docker</cite>. You can confirm that Docker is running properly by executing (might need <cite>sudo</cite>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="n">hello</span><span class="o">-</span><span class="n">world</span>
</pre></div>
</div>
<p>If successful, this will print an informational message telling you that you are ready to go.  Now, also install the <cite>docker-compose</cite> helper tool with <cite>sudo yum install docker-compose</cite> (might need <a class="reference external" href="https://fedoraproject.org/wiki/EPEL">EPEL</a> enabled). You are now ready to install the Rucio development environment.</p>
</div>
<div class="section" id="preparing-the-environment">
<h2>Preparing the environment<a class="headerlink" href="#preparing-the-environment" title="Permalink to this headline">¶</a></h2>
<p>The first step is to check if SELinux is running. SELinux will block access to the directories mounted inside the container, and so depending on you node might need to be put in permissive mode with <cite>setenforce permissive</cite>.</p>
<p>The second step is to fork the <a class="reference external" href="https://github.com/rucio/rucio">main Rucio repository on GitHub</a> by clicking the yellow Fork Star button, and then clone your private forked Rucio repository to your <cite>~/dev/rucio</cite>. Afterwards add the main upstream repository as an additional remote to be able to submit pull requests later on:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">~/</span><span class="n">dev</span>
<span class="n">git</span> <span class="n">clone</span> <span class="n">git</span><span class="nd">@github</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="o">&lt;</span><span class="n">your_username</span><span class="o">&gt;/</span><span class="n">rucio</span><span class="o">.</span><span class="n">git</span>
<span class="n">cd</span> <span class="n">rucio</span>
<span class="n">git</span> <span class="n">remote</span> <span class="n">add</span> <span class="n">upstream</span> <span class="n">git</span><span class="nd">@github</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="n">rucio</span><span class="o">/</span><span class="n">rucio</span><span class="o">.</span><span class="n">git</span>
<span class="n">git</span> <span class="n">fetch</span> <span class="o">--</span><span class="nb">all</span>
</pre></div>
</div>
<p>Now, ensure that the <cite>.git/config</cite> is proper, i.e., mentioning your full name and email address, and create the <cite>.githubtoken</cite> file that contains a full access token from <a class="reference external" href="https://github.com/settings/tokens">Github Account Settings</a>.</p>
<p>Next, startup the Rucio development environment with docker-compose. There are three different types: a standard one to just run the unittests and do basic development, which includes just Rucio without any transfer capabilities. One slightly larger one, which includes the File Transfer Service (FTS) and three XrootD storage servers to develop upload/download and transfers capabilities. And a third large one, which adds the full monitoring stack with Logstash, Elasticsearch, Kibana and Grafana.</p>
<div class="section" id="using-the-standard-environment">
<h3>Using the standard environment<a class="headerlink" href="#using-the-standard-environment" title="Permalink to this headline">¶</a></h3>
<p>Run the containers using docker-compose (again might need <cite>sudo</cite>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="o">--</span><span class="n">file</span> <span class="n">etc</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="o">.</span><span class="n">yml</span> <span class="n">up</span> <span class="o">-</span><span class="n">d</span>
</pre></div>
</div>
<p>And verify that it is running properly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">ps</span>
</pre></div>
</div>
<p>This should show you a few running containers: the Rucio server, the PostgreSQL database and the Graphite monitoring.</p>
<p>Finally, you can jump into the container with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">dev_rucio_1</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
</pre></div>
</div>
<p>To verify that everything is in order, you can now either run the full unit tests or only set up the database. Running the full testing suite takes ~10 minutes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tools</span><span class="o">/</span><span class="n">run_tests_docker</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>Alternatively, you can bootstrap the test environment once with the <cite>-i</cite> option and then selectively or repeatedly run test case modules, test case groups, or even single test cases, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tools</span><span class="o">/</span><span class="n">run_tests_docker</span><span class="o">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">i</span>
<span class="n">pytest</span> <span class="o">-</span><span class="n">v</span> <span class="o">--</span><span class="n">full</span><span class="o">-</span><span class="n">trace</span> <span class="n">lib</span><span class="o">/</span><span class="n">rucio</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">test_replica</span><span class="o">.</span><span class="n">py</span>
<span class="n">pytest</span> <span class="o">-</span><span class="n">v</span> <span class="o">--</span><span class="n">full</span><span class="o">-</span><span class="n">trace</span> <span class="n">lib</span><span class="o">/</span><span class="n">rucio</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">test_replica</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="n">TestReplicaCore</span>
<span class="n">pytest</span> <span class="o">-</span><span class="n">v</span> <span class="o">--</span><span class="n">full</span><span class="o">-</span><span class="n">trace</span> <span class="n">lib</span><span class="o">/</span><span class="n">rucio</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">test_replica</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="n">TestReplicaCore</span><span class="o">.</span><span class="n">test_delete_replicas_from_datasets</span>
</pre></div>
</div>
</div>
<div class="section" id="using-the-environment-including-storage">
<h3>Using the environment including storage<a class="headerlink" href="#using-the-environment-including-storage" title="Permalink to this headline">¶</a></h3>
<p>Again run the containers using docker-compose:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="o">--</span><span class="n">file</span> <span class="n">etc</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="o">-</span><span class="n">storage</span><span class="o">.</span><span class="n">yml</span> <span class="n">up</span> <span class="o">-</span><span class="n">d</span>
</pre></div>
</div>
<p>This should show you a few more running containers: the Rucio server, the PostgreSQL database, FTS and its associated MySQL database, the Graphite monitoring, and three XrootD storage servers.</p>
<p>With this container you can upload and download data to/from the storage and submit data transfers. To set this up, add the <cite>-r</cite> option to the setup.</p>
<blockquote>
<div><p>tools/run_tests_docker.sh -ir</p>
</div></blockquote>
<p>This creates a few random files and uploads them, creates a few datasets and containers, and requests a replication rule for the container, which starts in state REPLICATING. To demonstrate the transfer capability, the daemons can be run in single-execution mode in order:</p>
<blockquote>
<div><p>rucio rule-info &lt;rule-id&gt;</p>
<p>rucio-conveyor-submitter –run-once
rucio-conveyor-poller –run-once –older-than 0
rucio-conveyor-finisher –run-once</p>
<p>rucio rule-info &lt;rule-id&gt;</p>
</div></blockquote>
<p>On the second display of the rule, its state has cleared to OK.</p>
</div>
<div class="section" id="using-the-environment-including-monitoring">
<h3>Using the environment including monitoring<a class="headerlink" href="#using-the-environment-including-monitoring" title="Permalink to this headline">¶</a></h3>
<p>Again run the containers using docker-compose:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="o">--</span><span class="n">file</span> <span class="n">etc</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="o">-</span><span class="n">storage</span><span class="o">-</span><span class="n">monit</span><span class="o">.</span><span class="n">yml</span> <span class="n">up</span> <span class="o">-</span><span class="n">d</span>
</pre></div>
</div>
<p>Now you will have the same containers as before plus a full monitoring stack with Logstash, Elasticsearch, Kibana and Grafana.</p>
<p>To create some events and write them to Elasticsearch first run again the tests as before:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tools</span><span class="o">/</span><span class="n">run_tests_docker</span><span class="o">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">ir</span>
</pre></div>
</div>
<p>Then you will have to run the transfer daemons (conveyor-<a href="#id1"><span class="problematic" id="id2">*</span></a>) and messaging daemon (hermes) to send the events to ActiveMQ. There a script for that which repeats these daemons in single execution mode from the section in a loop:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">run_daemons</span>
</pre></div>
</div>
<p>When all the daemons ran you will be able to find the events in Kibana. If you run the docker environment on you local machine you can access Kibana at <a class="reference external" href="http://localhost:5601">http://localhost:5601</a>. The necessary index pattern will be added automatically. There is also one dashboard available in Kibana. If it is running on remote machine you can SSH forward it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="o">-</span><span class="n">L</span> <span class="mi">5601</span><span class="p">:</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">5601</span> <span class="o">&lt;</span><span class="n">hostname</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Additionally, there is also a Grafana server running with one simple dashboard. You can access it at <a class="reference external" href="http://localhost:3000">http://localhost:3000</a>. The default credentials are “admin/admin”. Also ActiveMQ web console can be accessed at <a class="reference external" href="http://localhost:8161">http://localhost:8161</a>.</p>
<p>If you would like to continously create some transfers and events there are scripts available for that. Open two different shells and in one run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">create_monit_data</span>
</pre></div>
</div>
<p>And in the other run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">run_daemons</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="development">
<h2>Development<a class="headerlink" href="#development" title="Permalink to this headline">¶</a></h2>
<p>The idea for containerised development is that you use your host machine to edit the files, and test the changes within the container environment. On your host machine, you should be able to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">~/</span><span class="n">dev</span><span class="o">/</span><span class="n">rucio</span>
<span class="n">emacs</span> <span class="o">&lt;</span><span class="n">file</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>To see your changes in action the recommended way is to jump twice into the container in parallel. One terminal to follow the output of the Rucio server with a shortcut to tail the logfiles (<cite>logshow</cite>), and one terminal to actually run interactive commands:</p>
<p>From your host, get a separate Terminal 1 (the Rucio “server log show”):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">dev_rucio_1</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">logshow</span>
</pre></div>
</div>
<p>Terminal 1 can now be left open, and then from your host go into a new Terminal 2 (the “interactive” terminal):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">dev_rucio_1</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">rucio</span> <span class="n">whoami</span>
</pre></div>
</div>
<p>The command will output in Terminal 2, and at the same time the server debug output will be shown in Terminal 1.</p>
<p>The same <cite>logshow</cite> is also available in the FTS container:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">dev_fts_1</span> <span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">bash</span>
<span class="n">logshow</span>
</pre></div>
</div>
</div>
<div class="section" id="development-tricks">
<h2>Development tricks<a class="headerlink" href="#development-tricks" title="Permalink to this headline">¶</a></h2>
<div class="section" id="server-changes">
<h3>Server changes<a class="headerlink" href="#server-changes" title="Permalink to this headline">¶</a></h3>
<p>If you edit server-side files, e.g. in <cite>lib/rucio/web</cite>, and your changes are not showing up then it is usually helpful to flush the memcache and force the webserver to restart without having to restart the container. Inside the container execute:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="s1">&#39;flush_all&#39;</span> <span class="o">|</span> <span class="n">nc</span> <span class="n">localhost</span> <span class="mi">11211</span> <span class="o">&amp;&amp;</span> <span class="n">httpd</span> <span class="o">-</span><span class="n">k</span> <span class="n">graceful</span>
</pre></div>
</div>
</div>
<div class="section" id="database-access">
<h3>Database access<a class="headerlink" href="#database-access" title="Permalink to this headline">¶</a></h3>
<p>The default database is PostgreSQL, and <cite>docker-compose</cite> is configured to open its port to the host machine. Using your favourite SQL navigator, e.g., <a class="reference external" href="https://dbeaver.org">DBeaver</a>, you can connect to the database using the default access on <cite>localhost:5432</cite> to database name <cite>rucio</cite>, schema name <cite>dev</cite>, with username <cite>rucio</cite> and password <cite>secret</cite>.</p>
</div>
<div class="section" id="docker-is-eating-my-disk-space">
<h3>Docker is eating my disk space<a class="headerlink" href="#docker-is-eating-my-disk-space" title="Permalink to this headline">¶</a></h3>
<p>You can reclaim this with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">system</span> <span class="n">prune</span> <span class="o">-</span><span class="n">f</span> <span class="o">--</span><span class="n">volumes</span>
</pre></div>
</div>
</div>
<div class="section" id="where-do-i-find-the-dockerfile">
<h3>Where do I find the Dockerfile<a class="headerlink" href="#where-do-i-find-the-dockerfile" title="Permalink to this headline">¶</a></h3>
<p>This container can be found on Dockerhub as <cite>rucio/rucio-dev</cite>, and the corresponding <a class="reference external" href="https://github.com/rucio/containers/tree/master/dev">Dockerfile</a> is also available. It provides a Rucio environment which allows you to mount your local code in the containers <cite>bin</cite>, <cite>lib</cite>, and <cite>tools</cite> directory. The container is set up to run against a PostgreSQL database with fsync and most durability features for the WAL disabled to improve testing IO throughput. Tests and checks can be run against the development code without having to rebuild the container.</p>
</div>
<div class="section" id="i-need-a-docker-based-on-another-branch-not-rucio-master">
<h3>I need a Docker based on another branch (not rucio/master)<a class="headerlink" href="#i-need-a-docker-based-on-another-branch-not-rucio-master" title="Permalink to this headline">¶</a></h3>
<p>In such case, you can download the Rucio container files and e.g. choose to modify the dev container before build:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">opt</span>
<span class="n">sudo</span> <span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">rucio</span><span class="o">/</span><span class="n">containers</span>
<span class="n">cd</span> <span class="o">../</span><span class="n">containers</span><span class="o">/</span><span class="n">dev</span>
</pre></div>
</div>
<p>Change anything you need, e.g. the code branch cloned to your docker container:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># from</span>
<span class="n">RUN</span> <span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">rucio</span><span class="o">/</span><span class="n">rucio</span><span class="o">.</span><span class="n">git</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">rucio</span>
<span class="c1"># to e.g.:</span>
<span class="n">RUN</span> <span class="n">git</span> <span class="n">clone</span> <span class="o">--</span><span class="n">single</span><span class="o">-</span><span class="n">branch</span> <span class="o">--</span><span class="n">branch</span> <span class="nb">next</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">rucio</span><span class="o">/</span><span class="n">rucio</span><span class="o">.</span><span class="n">git</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">rucio</span>
</pre></div>
</div>
<p># build your docker
sudo docker build -t rucio/rucio-dev .</p>
<p>Compose as usual using docker-compose:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">rucio</span>
<span class="n">sudo</span> <span class="n">docker</span><span class="o">-</span><span class="n">compose</span> <span class="o">--</span><span class="n">file</span> <span class="n">etc</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="o">.</span><span class="n">yml</span> <span class="n">up</span> <span class="o">-</span><span class="n">d</span>
</pre></div>
</div>
</div>
<div class="section" id="start-the-daemons">
<h3>Start the daemons<a class="headerlink" href="#start-the-daemons" title="Permalink to this headline">¶</a></h3>
<p>Daemons are not running in the docker environment, but all daemons support single-execution mode with the –run-once argument. Reset the system first with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tools</span><span class="o">/</span><span class="n">run_tests_docker</span><span class="o">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">ir</span>
</pre></div>
</div>
<p>Some files are created. Let’s add them to a new dataset:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rucio</span> <span class="n">add</span><span class="o">-</span><span class="n">dataset</span> <span class="n">test</span><span class="p">:</span><span class="n">mynewdataset</span>
<span class="n">rucio</span> <span class="n">attach</span> <span class="n">test</span><span class="p">:</span><span class="n">mynewdataset</span> <span class="n">test</span><span class="p">:</span><span class="n">file1</span> <span class="n">test</span><span class="p">:</span><span class="n">file2</span> <span class="n">test</span><span class="p">:</span><span class="n">file3</span> <span class="n">test</span><span class="p">:</span><span class="n">file4</span>
</pre></div>
</div>
<p>If you run the command below, the files are not in the RSE XRD3, but only in XRD1 and 2.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rucio</span> <span class="nb">list</span><span class="o">-</span><span class="n">file</span><span class="o">-</span><span class="n">replicas</span> <span class="n">test</span><span class="p">:</span><span class="n">mynewdataset</span>
<span class="o">&gt;</span> <span class="o">+---------+--------+------------+-----------+------------------------------------------------+</span>
<span class="o">&gt;</span> <span class="o">|</span> <span class="n">SCOPE</span>   <span class="o">|</span> <span class="n">NAME</span>   <span class="o">|</span> <span class="n">FILESIZE</span>   <span class="o">|</span> <span class="n">ADLER32</span>   <span class="o">|</span> <span class="n">RSE</span><span class="p">:</span> <span class="n">REPLICA</span>                                   <span class="o">|</span>
<span class="o">&gt;</span> <span class="o">|---------+--------+------------+-----------+------------------------------------------------|</span>
<span class="o">&gt;</span> <span class="o">|</span> <span class="n">test</span>    <span class="o">|</span> <span class="n">file1</span>  <span class="o">|</span> <span class="mf">10.486</span> <span class="n">MB</span>  <span class="o">|</span> <span class="mi">141</span><span class="n">a641e</span>  <span class="o">|</span> <span class="n">XRD1</span><span class="p">:</span> <span class="n">root</span><span class="p">:</span><span class="o">//</span><span class="n">xrd1</span><span class="p">:</span><span class="mi">1094</span><span class="o">//</span><span class="n">rucio</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="mi">80</span><span class="o">/</span><span class="mi">25</span><span class="o">/</span><span class="n">file1</span> <span class="o">|</span>
<span class="o">&gt;</span> <span class="o">|</span> <span class="n">test</span>    <span class="o">|</span> <span class="n">file2</span>  <span class="o">|</span> <span class="mf">10.486</span> <span class="n">MB</span>  <span class="o">|</span> <span class="n">fdfa7eea</span>  <span class="o">|</span> <span class="n">XRD1</span><span class="p">:</span> <span class="n">root</span><span class="p">:</span><span class="o">//</span><span class="n">xrd1</span><span class="p">:</span><span class="mi">1094</span><span class="o">//</span><span class="n">rucio</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">f3</span><span class="o">/</span><span class="mi">14</span><span class="o">/</span><span class="n">file2</span> <span class="o">|</span>
<span class="o">&gt;</span> <span class="o">|</span> <span class="n">test</span>    <span class="o">|</span> <span class="n">file3</span>  <span class="o">|</span> <span class="mf">10.486</span> <span class="n">MB</span>  <span class="o">|</span> <span class="n">c669167d</span>  <span class="o">|</span> <span class="n">XRD2</span><span class="p">:</span> <span class="n">root</span><span class="p">:</span><span class="o">//</span><span class="n">xrd2</span><span class="p">:</span><span class="mi">1095</span><span class="o">//</span><span class="n">rucio</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">a9</span><span class="o">/</span><span class="mi">23</span><span class="o">/</span><span class="n">file3</span> <span class="o">|</span>
<span class="o">&gt;</span> <span class="o">|</span> <span class="n">test</span>    <span class="o">|</span> <span class="n">file4</span>  <span class="o">|</span> <span class="mf">10.486</span> <span class="n">MB</span>  <span class="o">|</span> <span class="mf">65786e49</span>  <span class="o">|</span> <span class="n">XRD2</span><span class="p">:</span> <span class="n">root</span><span class="p">:</span><span class="o">//</span><span class="n">xrd2</span><span class="p">:</span><span class="mi">1095</span><span class="o">//</span><span class="n">rucio</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="mi">2</span><span class="n">b</span><span class="o">/</span><span class="n">c2</span><span class="o">/</span><span class="n">file4</span> <span class="o">|</span>
<span class="o">&gt;</span> <span class="o">+---------+--------+------------+-----------+------------------------------------------------+</span>
</pre></div>
</div>
<p>So let’s add a new rule on our new dataset to oblige Rucio to create replicas also on XRD3:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rucio</span> <span class="n">add</span><span class="o">-</span><span class="n">rule</span> <span class="n">test</span><span class="p">:</span><span class="n">mynewdataset</span> <span class="mi">1</span> <span class="n">XRD3</span>
<span class="o">&gt;</span> <span class="mi">1</span><span class="n">aadd685d891400dba050ad43e71fea9</span>
</pre></div>
</div>
<p>Now we can check the status of the rule. We will see there are 4 files in <cite>Replicating</cite> state:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rucio</span> <span class="n">rule</span><span class="o">-</span><span class="n">info</span> <span class="mi">1</span><span class="n">aadd685d891400dba050ad43e71fea9</span><span class="o">|</span><span class="n">grep</span> <span class="n">Locks</span>
<span class="o">&gt;</span> <span class="n">Locks</span> <span class="n">OK</span><span class="o">/</span><span class="n">REPLICATING</span><span class="o">/</span><span class="n">STUCK</span><span class="p">:</span> <span class="mi">0</span><span class="o">/</span><span class="mi">4</span><span class="o">/</span><span class="mi">0</span>
</pre></div>
</div>
<p>Now we can run the daemons. First the rule evaluation daemon (judge-evaluator) will pick up our rule. Then the transfer submitter daemon (conveyor-submitter) will send the newly created transfers requests to the FTS server. After that, the transfer state check daemon (conveyor-poller) will retrieve from FTS the transfer state information. Finally, the transfer sign-off daemon (conveyor-finisher) updates the internal state of the Rucio catalogue to reflect the changes.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rucio</span><span class="o">-</span><span class="n">judge</span><span class="o">-</span><span class="n">evaluator</span> <span class="o">--</span><span class="n">run</span><span class="o">-</span><span class="n">once</span>
<span class="n">rucio</span><span class="o">-</span><span class="n">conveyor</span><span class="o">-</span><span class="n">submitter</span> <span class="o">--</span><span class="n">run</span><span class="o">-</span><span class="n">once</span>
<span class="n">rucio</span><span class="o">-</span><span class="n">conveyor</span><span class="o">-</span><span class="n">poller</span> <span class="o">--</span><span class="n">run</span><span class="o">-</span><span class="n">once</span>
<span class="n">rucio</span><span class="o">-</span><span class="n">conveyor</span><span class="o">-</span><span class="n">finisher</span> <span class="o">--</span><span class="n">run</span><span class="o">-</span><span class="n">once</span>
</pre></div>
</div>
<p>If we see the state of the rule now, we see the locks are OK:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rucio</span> <span class="n">rule</span><span class="o">-</span><span class="n">info</span> <span class="mi">1</span><span class="n">aadd685d891400dba050ad43e71fea9</span><span class="o">|</span><span class="n">grep</span> <span class="n">Locks</span>
<span class="o">&gt;</span> <span class="n">Locks</span> <span class="n">OK</span><span class="o">/</span><span class="n">REPLICATING</span><span class="o">/</span><span class="n">STUCK</span><span class="p">:</span> <span class="mi">4</span><span class="o">/</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span>
</pre></div>
</div>
<p>And if we look at the replicas of the dataset, we see the there are replicas of the files also in XRD3:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rucio</span> <span class="nb">list</span><span class="o">-</span><span class="n">file</span><span class="o">-</span><span class="n">replicas</span> <span class="n">test</span><span class="p">:</span><span class="n">mynewdataset</span>
<span class="o">&gt;</span> <span class="o">+---------+--------+------------+-----------+------------------------------------------------+</span>
<span class="o">&gt;</span> <span class="o">|</span> <span class="n">SCOPE</span>   <span class="o">|</span> <span class="n">NAME</span>   <span class="o">|</span> <span class="n">FILESIZE</span>   <span class="o">|</span> <span class="n">ADLER32</span>   <span class="o">|</span> <span class="n">RSE</span><span class="p">:</span> <span class="n">REPLICA</span>                                   <span class="o">|</span>
<span class="o">&gt;</span> <span class="o">|---------+--------+------------+-----------+------------------------------------------------|</span>
<span class="o">&gt;</span> <span class="o">|</span> <span class="n">test</span>    <span class="o">|</span> <span class="n">file1</span>  <span class="o">|</span> <span class="mf">10.486</span> <span class="n">MB</span>  <span class="o">|</span> <span class="mi">141</span><span class="n">a641e</span>  <span class="o">|</span> <span class="n">XRD3</span><span class="p">:</span> <span class="n">root</span><span class="p">:</span><span class="o">//</span><span class="n">xrd3</span><span class="p">:</span><span class="mi">1096</span><span class="o">//</span><span class="n">rucio</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="mi">80</span><span class="o">/</span><span class="mi">25</span><span class="o">/</span><span class="n">file1</span> <span class="o">|</span>
<span class="o">&gt;</span> <span class="o">|</span> <span class="n">test</span>    <span class="o">|</span> <span class="n">file1</span>  <span class="o">|</span> <span class="mf">10.486</span> <span class="n">MB</span>  <span class="o">|</span> <span class="mi">141</span><span class="n">a641e</span>  <span class="o">|</span> <span class="n">XRD1</span><span class="p">:</span> <span class="n">root</span><span class="p">:</span><span class="o">//</span><span class="n">xrd1</span><span class="p">:</span><span class="mi">1094</span><span class="o">//</span><span class="n">rucio</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="mi">80</span><span class="o">/</span><span class="mi">25</span><span class="o">/</span><span class="n">file1</span> <span class="o">|</span>
<span class="o">&gt;</span> <span class="o">|</span> <span class="n">test</span>    <span class="o">|</span> <span class="n">file2</span>  <span class="o">|</span> <span class="mf">10.486</span> <span class="n">MB</span>  <span class="o">|</span> <span class="n">fdfa7eea</span>  <span class="o">|</span> <span class="n">XRD3</span><span class="p">:</span> <span class="n">root</span><span class="p">:</span><span class="o">//</span><span class="n">xrd3</span><span class="p">:</span><span class="mi">1096</span><span class="o">//</span><span class="n">rucio</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">f3</span><span class="o">/</span><span class="mi">14</span><span class="o">/</span><span class="n">file2</span> <span class="o">|</span>
<span class="o">&gt;</span> <span class="o">|</span> <span class="n">test</span>    <span class="o">|</span> <span class="n">file2</span>  <span class="o">|</span> <span class="mf">10.486</span> <span class="n">MB</span>  <span class="o">|</span> <span class="n">fdfa7eea</span>  <span class="o">|</span> <span class="n">XRD1</span><span class="p">:</span> <span class="n">root</span><span class="p">:</span><span class="o">//</span><span class="n">xrd1</span><span class="p">:</span><span class="mi">1094</span><span class="o">//</span><span class="n">rucio</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">f3</span><span class="o">/</span><span class="mi">14</span><span class="o">/</span><span class="n">file2</span> <span class="o">|</span>
<span class="o">&gt;</span> <span class="o">|</span> <span class="n">test</span>    <span class="o">|</span> <span class="n">file3</span>  <span class="o">|</span> <span class="mf">10.486</span> <span class="n">MB</span>  <span class="o">|</span> <span class="n">c669167d</span>  <span class="o">|</span> <span class="n">XRD2</span><span class="p">:</span> <span class="n">root</span><span class="p">:</span><span class="o">//</span><span class="n">xrd2</span><span class="p">:</span><span class="mi">1095</span><span class="o">//</span><span class="n">rucio</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">a9</span><span class="o">/</span><span class="mi">23</span><span class="o">/</span><span class="n">file3</span> <span class="o">|</span>
<span class="o">&gt;</span> <span class="o">|</span> <span class="n">test</span>    <span class="o">|</span> <span class="n">file3</span>  <span class="o">|</span> <span class="mf">10.486</span> <span class="n">MB</span>  <span class="o">|</span> <span class="n">c669167d</span>  <span class="o">|</span> <span class="n">XRD3</span><span class="p">:</span> <span class="n">root</span><span class="p">:</span><span class="o">//</span><span class="n">xrd3</span><span class="p">:</span><span class="mi">1096</span><span class="o">//</span><span class="n">rucio</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">a9</span><span class="o">/</span><span class="mi">23</span><span class="o">/</span><span class="n">file3</span> <span class="o">|</span>
<span class="o">&gt;</span> <span class="o">|</span> <span class="n">test</span>    <span class="o">|</span> <span class="n">file4</span>  <span class="o">|</span> <span class="mf">10.486</span> <span class="n">MB</span>  <span class="o">|</span> <span class="mf">65786e49</span>  <span class="o">|</span> <span class="n">XRD2</span><span class="p">:</span> <span class="n">root</span><span class="p">:</span><span class="o">//</span><span class="n">xrd2</span><span class="p">:</span><span class="mi">1095</span><span class="o">//</span><span class="n">rucio</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="mi">2</span><span class="n">b</span><span class="o">/</span><span class="n">c2</span><span class="o">/</span><span class="n">file4</span> <span class="o">|</span>
<span class="o">&gt;</span> <span class="o">|</span> <span class="n">test</span>    <span class="o">|</span> <span class="n">file4</span>  <span class="o">|</span> <span class="mf">10.486</span> <span class="n">MB</span>  <span class="o">|</span> <span class="mf">65786e49</span>  <span class="o">|</span> <span class="n">XRD3</span><span class="p">:</span> <span class="n">root</span><span class="p">:</span><span class="o">//</span><span class="n">xrd3</span><span class="p">:</span><span class="mi">1096</span><span class="o">//</span><span class="n">rucio</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="mi">2</span><span class="n">b</span><span class="o">/</span><span class="n">c2</span><span class="o">/</span><span class="n">file4</span> <span class="o">|</span>
<span class="o">&gt;</span> <span class="o">+---------+--------+------------+-----------+------------------------------------------------+</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="cli_admin_examples.html" class="btn btn-neutral float-right" title="Rucio administration CLI: Examples" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="policy_packages.html" class="btn btn-neutral float-left" title="Policy packages" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2012-2018 CERN for the benefit of the ATLAS collaboration

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>